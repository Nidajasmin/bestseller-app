generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Shop {
  shopifyDomain  String          @id
  accessToken    String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  appCollections AppCollection[]
  settings       Settings?   
}

model AppCollection {
  id                  Int                  @id @default(autoincrement())
  shopifyDomain       String
  collectionId        String
  enabled             Boolean              @default(false)
  shop                Shop                 @relation(fields: [shopifyDomain], references: [shopifyDomain], onDelete: Cascade)
  collectionSetting   CollectionSetting?
  featuredProducts    FeaturedProduct[]
  productBehaviorRule ProductBehaviorRule?
  tagSortingRules     TagSortingRule[]
  featuredSettings    FeaturedSettings?

  @@unique([shopifyDomain, collectionId])
}

model CollectionSetting {
  id               Int           @id @default(autoincrement())
  shopifyDomain    String
  collectionId     String
  useCustomSorting Boolean       @default(false)
  primarySortOrder String?
  lookbackPeriod   Int           @default(30)
  includeDiscounts Boolean       @default(true)
  ordersRange      String        @default("all-orders")
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  appCollection    AppCollection @relation(fields: [shopifyDomain, collectionId], references: [shopifyDomain, collectionId], onDelete: Cascade)

  @@unique([shopifyDomain, collectionId])
}

model FeaturedProduct {
  id            Int           @id @default(autoincrement())
  shopifyDomain String
  collectionId  String
  productId     String
  position      Int
  featuredType  String        @default("manual")
  daysToFeature Int?
  startDate     DateTime?
  scheduleApplied Boolean     @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  appCollection AppCollection @relation(fields: [shopifyDomain, collectionId], references: [shopifyDomain, collectionId], onDelete: Cascade)

  @@unique([shopifyDomain, collectionId, productId])
}

model FeaturedSettings {
  id            Int           @id @default(autoincrement())
  shopifyDomain String
  collectionId  String
  sortOrder     String        @default("manual")
  limitFeatured Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  appCollection AppCollection @relation(fields: [shopifyDomain, collectionId], references: [shopifyDomain, collectionId], onDelete: Cascade)

  @@unique([shopifyDomain, collectionId])
}

model ProductBehaviorRule {
  id                           Int           @id @default(autoincrement())
  shopifyDomain                String
  collectionId                 String
  pushNewProductsUp            Boolean       @default(false)
  newProductDays               Int           @default(7)
  pushDownOutOfStock           Boolean       @default(false)
  outOfStockVsNewPriority      String        @default("PUSH_DOWN")
  outOfStockVsFeaturedPriority String        @default("KEEP_FEATURED")
  outOfStockVsTagsPriority     String        @default("KEEP_TAGGED")
  createdAt                    DateTime      @default(now())
  updatedAt                    DateTime      @updatedAt
  appCollection                AppCollection @relation(fields: [shopifyDomain, collectionId], references: [shopifyDomain, collectionId], onDelete: Cascade)

  @@unique([shopifyDomain, collectionId])
}

model TagSortingRule {
  id            Int           @id @default(autoincrement())
  shopifyDomain String
  collectionId  String
  tagName       String
  position      String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  appCollection AppCollection @relation(fields: [shopifyDomain, collectionId], references: [shopifyDomain, collectionId], onDelete: Cascade)

  @@unique([shopifyDomain, collectionId, tagName])
}

model Session {
  id            String    @id @default(cuid())
  shop          String    @unique
  state         String
  isOnline      Boolean   @default(true)
  scope         String?
  expires       DateTime?
  accessToken   String?
  userId        String?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  country       String?
  collaborator  Boolean   @default(false)
  emailVerified Boolean   @default(false)
  locale        String?
}

// New models for collection manager
model Settings {
  id                       String   @id @default(cuid())
  shopifyDomain            String   @unique  // Use shopifyDomain instead of shopId
  shop                     Shop     @relation(fields: [shopifyDomain], references: [shopifyDomain], onDelete: Cascade)
  
  // Bestsellers settings
  bestsellersEnabled       Boolean  @default(true)
  bestsellersTag           String   @default("bestsellers-resort")
  bestsellersCount         Int      @default(50)
  bestsellersLookback      Int      @default(180) // 6 months (180 days)
  bestsellersExcludeOOS    Boolean  @default(true)
  bestsellersCreateCollection Boolean @default(true)
  bestsellersCollectionId  String?
  
  // Trending settings
  trendingEnabled          Boolean  @default(true)
  trendingTag              String   @default("br-trending")
  trendingCount            Int      @default(50)
  trendingLookback         Int      @default(7) // days
  trendingExcludeOOS       Boolean  @default(false)
  trendingCreateCollection Boolean  @default(false)
  trendingCollectionId     String?
  trendingCollectionTitle  String?
  
  // New Arrivals settings
  newArrivalsEnabled       Boolean  @default(true)
  newArrivalsTag           String   @default("br-new")
  newArrivalsCount         Int      @default(50)
  newArrivalsPeriod        Int      @default(7) // days
  newArrivalsExcludeOOS    Boolean  @default(true)
  newArrivalsCreateCollection Boolean @default(true)
  newArrivalsCollectionId  String?
  newArrivalsCollectionTitle String?
  
  // Aging Inventory settings
  agingEnabled             Boolean  @default(true)
  agingTag                 String   @default("br-aging")
  agingCount               Int      @default(50)
  agingLookback            Int      @default(90) // days
  agingCreateCollection    Boolean  @default(true)
  agingCollectionId        String?
  agingCollectionTitle     String?
  
  // Additional settings
  excludeEnabled           Boolean  @default(true)
  excludeTags              String[] @default([])
  
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@map("settings")
}

model Collection {
  id          String   @id @default(cuid())
  shopifyId   String   @unique
  title       String
  handle      String
  shopifyDomain String  // Use shopifyDomain instead of shopId
  type        String   // "bestsellers", "trending", "new_arrivals", "aging"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("collections")
}

model ProductTag {
  id          String   @id @default(cuid())
  shopifyId   String
  tag         String
  type        String   // "bestsellers", "trending", "new_arrivals", "aging"
  shopifyDomain String  // Use shopifyDomain instead of shopId
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([shopifyId, tag])
  @@map("product_tags")
}